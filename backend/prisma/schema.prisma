// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql" // เปลี่ยนเป็น DB ที่ใช้จริง
  url      = env("DATABASE_URL")
}

model Company {
  CompanyId        Int      @id @default(autoincrement())
  CompanyName      String
  CompanyAddress   String?
  TaxId            String?
  CompanyCode      String   @unique
  CompanyTelNumber String?
  CompanyEmail     String?
  CompanyStatus    String   @default("ACTIVE")
  CreatedAt        DateTime @default(now())
  CreatedBy        Int?
  UpdatedAt        DateTime @updatedAt
  UpdatedBy        Int?

  @@index([CompanyName])
  @@index([CompanyCode])
  @@index([CompanyStatus])

  CreatedByUser User? @relation("CompanyCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser User? @relation("CompanyUpdatedBy", fields: [UpdatedBy], references: [UserId])

  Users                   User[]
  Branches                Branch[]
  Suppliers               Supplier[]
  Materials               Material[]
  PurchaseOrders          PurchaseOrder[]
  Catagories              Catagory[]
  Stocks                  Stock[]
  Receipts                Receipt[]
  WithdrawnRequests       WithdrawnRequest[]
  ReceiptDetails          ReceiptDetail[]
  WithdrawnRequestDetails WithdrawnRequestDetail[]
  Issues                  Issue[]
  IssueDetails            IssueDetail[]
  PurchaseOrderDetails    PurchaseOrderDetail[]
  Warehouses              Warehouse[]
}

// Temporary company info provided at user signup before system admin approves
model TempCompany {
  TempCompanyId        Int      @id @default(autoincrement())
  TempCompanyName      String
  TempCompanyAddress   String?
  TempCompanyTaxId     String?
  TempCompanyCode      String   @unique
  TempCompanyTelNumber String?
  TempCompanyEmail     String?
  CreatedAt            DateTime @default(now())
  CreatedBy            Int?
  UpdatedAt            DateTime @updatedAt
  UpdatedBy            Int?

  @@index([TempCompanyName])
  @@index([TempCompanyCode])

  CreatedByUser User? @relation("TempCompanyCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser User? @relation("TempCompanyUpdatedBy", fields: [UpdatedBy], references: [UserId])

  Users        User[]
}

model Warehouse {
  WarehouseId      Int      @id @default(autoincrement())
  WarehouseName    String
  CompanyId        Int
  WarehouseAddress String?
  WarehouseCode    String   @unique
  CreatedAt        DateTime @default(now())
  CreatedBy        Int?
  UpdatedAt        DateTime @updatedAt
  UpdatedBy        Int?

  @@index([WarehouseName])
  @@index([CompanyId])
  @@index([WarehouseCode])

  CreatedByUser User?   @relation("WarehouseCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser User?   @relation("WarehouseUpdatedBy", fields: [UpdatedBy], references: [UserId])

  Company      Company @relation(fields: [CompanyId], references: [CompanyId])

  Stocks         Stock[]
  ReceiptDetails ReceiptDetail[]
}

model User {
  UserId      Int      @id @default(autoincrement())
  UserName    String   @unique
  // Deprecated: original combined status, retained for backward compatibility
  UserStatus  String   @default("PENDING") // legacy field
  // System admin approval status: PENDING, APPROVED, REJECTED
  UserStatusApprove String @default("PENDING")
  // Membership active status within assigned company: ACTIVE or INACTIVE
  UserStatusActive  String @default("ACTIVE")
  // Free-text role requested at signup; platform admin will choose actual Role later
  RequestedRoleText String?
  UserPassword String
  RoleId      Int
  BranchId    Int
  CompanyId   Int
  TempCompanyId Int?
  TelNumber   String?
  Email       String?
  LineId      String?
  CreatedAt   DateTime @default(now())
  CreatedBy   Int?
  UpdatedAt   DateTime @updatedAt
  UpdatedBy   Int?

  @@index([UserName])
  @@index([BranchId])
  @@index([CompanyId])
  @@index([TempCompanyId])
  @@index([UserStatusApprove])
  @@index([UserStatusActive])
  @@index([RequestedRoleText])

  Role        Role     @relation(fields: [RoleId], references: [RoleId])
  Branch      Branch   @relation(fields: [BranchId], references: [BranchId])
  Company     Company  @relation(fields: [CompanyId], references: [CompanyId])
  TempCompany TempCompany? @relation(fields: [TempCompanyId], references: [TempCompanyId])

  BranchCreatedBy               Branch[]               @relation("BranchCreatedBy")
  BranchUpdatedBy               Branch[]               @relation("BranchUpdatedBy")
  PurchaseOrderDetailCreatedBy  PurchaseOrderDetail[]  @relation("PurchaseOrderDetailCreatedBy")
  PurchaseOrderDetailUpdatedBy  PurchaseOrderDetail[]  @relation("PurchaseOrderDetailUpdatedBy")
  SupplierCreatedBy             Supplier[]             @relation("SupplierCreatedBy")
  SupplierUpdatedBy             Supplier[]             @relation("SupplierUpdatedBy")
  MaterialCreatedBy             Material[]             @relation("MaterialCreatedBy")
  MaterialUpdatedBy             Material[]             @relation("MaterialUpdatedBy")
  PurchaseOrderCreatedBy        PurchaseOrder[]        @relation("PurchaseOrderCreatedBy")
  PurchaseOrderUpdatedBy        PurchaseOrder[]        @relation("PurchaseOrderUpdatedBy")
  CatagoryCreatedBy             Catagory[]             @relation("CatagoryCreatedBy")
  CatagoryUpdatedBy             Catagory[]             @relation("CatagoryUpdatedBy")
  StockCreatedBy                Stock[]                @relation("StockCreatedBy")
  StockUpdatedBy                Stock[]                @relation("StockUpdatedBy")
  ReceiptCreatedBy              Receipt[]              @relation("ReceiptCreatedBy")
  ReceiptUpdatedBy              Receipt[]              @relation("ReceiptUpdatedBy")
  WithdrawnRequestCreatedBy     WithdrawnRequest[]     @relation("WithdrawnRequestCreatedBy")
  WithdrawnRequestUpdatedBy     WithdrawnRequest[]     @relation("WithdrawnRequestUpdatedBy")
  ReceiptDetailCreatedBy        ReceiptDetail[]        @relation("ReceiptDetailCreatedBy")
  ReceiptDetailUpdatedBy        ReceiptDetail[]        @relation("ReceiptDetailUpdatedBy")
  WithdrawnRequestDetailCreatedBy WithdrawnRequestDetail[] @relation("WithdrawnRequestDetailCreatedBy")
  WithdrawnRequestDetailUpdatedBy WithdrawnRequestDetail[] @relation("WithdrawnRequestDetailUpdatedBy")
  IssueCreatedBy                Issue[]                @relation("IssueCreatedBy")
  IssueUpdatedBy                Issue[]                @relation("IssueUpdatedBy")
  IssueDetailCreatedBy          IssueDetail[]          @relation("IssueDetailCreatedBy")
  IssueDetailUpdatedBy          IssueDetail[]          @relation("IssueDetailUpdatedBy")
  CompanyCreatedBy              Company[]              @relation("CompanyCreatedBy")
  CompanyUpdatedBy              Company[]              @relation("CompanyUpdatedBy")
  WarehouseCreatedBy            Warehouse[]            @relation("WarehouseCreatedBy")
  WarehouseUpdatedBy            Warehouse[]            @relation("WarehouseUpdatedBy")
  TempCompanyCreatedBy          TempCompany[]          @relation("TempCompanyCreatedBy")
  TempCompanyUpdatedBy          TempCompany[]          @relation("TempCompanyUpdatedBy")
}

model Branch {
  BranchId      Int      @id @default(autoincrement())
  BranchName    String
  CompanyId     Int
  BranchAddress String?
  BranchCode    String   @unique
  CreatedAt     DateTime @default(now())
  CreatedBy     Int?
  UpdatedAt     DateTime @updatedAt
  UpdatedBy     Int?

  @@index([BranchName])
  @@index([CompanyId])

  CreatedByUser User? @relation("BranchCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser User? @relation("BranchUpdatedBy", fields: [UpdatedBy], references: [UserId])

  Company            Company @relation(fields: [CompanyId], references: [CompanyId])
  Users                User[]
  WithdrawnRequests    WithdrawnRequest[]
  Issues               Issue[]
}

model PurchaseOrderDetail {
  PurchaseOrderDetailId Int      @id @default(autoincrement())
  PurchaseOrderId       Int
  MaterialId            Int
  CompanyId             Int
  PurchaseOrderQuantity Int
  PurchaseOrderPrice    Float
  PurchaseOrderUnit     String
  CreatedAt             DateTime @default(now())
  CreatedBy             Int?
  UpdatedAt             DateTime @updatedAt
  UpdatedBy             Int?

  @@index([PurchaseOrderId])
  @@index([MaterialId])
  @@index([CompanyId])

  CreatedByUser         User? @relation("PurchaseOrderDetailCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser         User? @relation("PurchaseOrderDetailUpdatedBy", fields: [UpdatedBy], references: [UserId])

  PurchaseOrder         PurchaseOrder @relation(fields: [PurchaseOrderId], references: [PurchaseOrderId])
  Material              Material      @relation(fields: [MaterialId], references: [MaterialId])
  Company               Company       @relation(fields: [CompanyId], references: [CompanyId])

  ReceiptDetails        ReceiptDetail[]

  @@unique([PurchaseOrderId, MaterialId])
}

model Role {
  RoleId    Int    @id @default(autoincrement())
  RoleName  String
  RoleCode  String @unique

  @@index([RoleName])

  Users     User[]

}

model Supplier {
  SupplierId         Int    @id @default(autoincrement())
  SupplierName       String
  CompanyId          Int
  SupplierAddress    String?
  SupplierCode       String @unique
  SupplierTelNumber  String?
  CreatedAt          DateTime @default(now())
  CreatedBy          Int?
  UpdatedAt          DateTime @updatedAt
  UpdatedBy          Int?

  @@index([SupplierName])
  @@index([SupplierCode])
  @@index([CompanyId])

  CreatedByUser      User? @relation("SupplierCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser      User? @relation("SupplierUpdatedBy", fields: [UpdatedBy], references: [UserId])

  Company            Company @relation(fields: [CompanyId], references: [CompanyId])
  PurchaseOrders     PurchaseOrder[]
}

model Material {
  MaterialId     Int     @id @default(autoincrement())
  MaterialName   String
  Unit           String
  Price          Float
  CatagoryId     Int
  CompanyId      Int
  MaterialCode   String  @unique
  CreatedAt      DateTime @default(now())
  CreatedBy      Int?
  UpdatedAt      DateTime @updatedAt
  UpdatedBy      Int?

  @@index([MaterialName])
  @@index([MaterialCode])
  @@index([CompanyId])

  CreatedByUser  User? @relation("MaterialCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser  User? @relation("MaterialUpdatedBy", fields: [UpdatedBy], references: [UserId])

  Catagory       Catagory @relation(fields: [CatagoryId], references: [CatagoryId])
  Company        Company  @relation(fields: [CompanyId], references: [CompanyId])
  Stocks         Stock[]
  PurchaseOrderDetails PurchaseOrderDetail[]
  ReceiptDetails ReceiptDetail[]
  WithdrawnRequestDetails WithdrawnRequestDetail[]
  IssueDetails   IssueDetail[]
}

model PurchaseOrder {
  PurchaseOrderId        Int     @id @default(autoincrement())
  DateTime              DateTime
  TotalPrice            Float
  SupplierId            Int
  CompanyId             Int
  PurchaseOrderCode     String  @unique
  PurchaseOrderStatus   String
  PurchaseOrderAddress  String?
  ContactName           String?
  ContactPhoneNumber    String?
  CreatedAt             DateTime @default(now())
  CreatedBy             Int?
  UpdatedAt             DateTime @updatedAt
  UpdatedBy             Int?

  @@index([PurchaseOrderCode])
  @@index([PurchaseOrderStatus])
  @@index([CompanyId])

  CreatedByUser         User? @relation("PurchaseOrderCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser         User? @relation("PurchaseOrderUpdatedBy", fields: [UpdatedBy], references: [UserId])

  Supplier              Supplier @relation(fields: [SupplierId], references: [SupplierId])
  Company               Company  @relation(fields: [CompanyId], references: [CompanyId])
  PurchaseOrderDetails  PurchaseOrderDetail[]
  Receipts              Receipt[]
  Stocks                Stock[]
}

model Catagory {
  CatagoryId     Int     @id @default(autoincrement())
  CatagoryName   String
  CompanyId      Int
  CatagoryCode   String  @unique
  CreatedAt      DateTime @default(now())
  CreatedBy      Int?
  UpdatedAt      DateTime @updatedAt
  UpdatedBy      Int?

  @@index([CatagoryName])
  @@index([CatagoryCode])
  @@index([CompanyId])

  CreatedByUser  User? @relation("CatagoryCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser  User? @relation("CatagoryUpdatedBy", fields: [UpdatedBy], references: [UserId])

  Company        Company  @relation(fields: [CompanyId], references: [CompanyId])
  Materials      Material[]
}

model Stock {
  StockId         Int     @id @default(autoincrement())
  MaterialId      Int
  CompanyId       Int
  WarehouseId     Int
  Quantity        Int
  Barcode         String  @unique
  StockPrice      Float
  ReceiptId       Int?
  PurchaseOrderId Int?
  Issue           Int?
  Remain          Int?
  CreatedAt       DateTime @default(now())
  CreatedBy       Int?
  UpdatedAt       DateTime @updatedAt
  UpdatedBy       Int?

  @@index([Barcode])
  @@index([CompanyId])
  @@index([WarehouseId])

  CreatedByUser   User? @relation("StockCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser   User? @relation("StockUpdatedBy", fields: [UpdatedBy], references: [UserId])

  Material        Material @relation(fields: [MaterialId], references: [MaterialId])
  Receipt         Receipt? @relation(fields: [ReceiptId], references: [ReceiptId])
  PurchaseOrder   PurchaseOrder? @relation(fields: [PurchaseOrderId], references: [PurchaseOrderId])
  Company         Company  @relation(fields: [CompanyId], references: [CompanyId])
  Warehouse       Warehouse @relation(fields: [WarehouseId], references: [WarehouseId])
}

model Receipt {
  ReceiptId          Int     @id @default(autoincrement())
  ReceiptDateTime    DateTime
  ReceiptTotalPrice  Float
  PurchaseOrderId    Int
  CompanyId          Int
  ReceiptCode        String  @unique
  CreatedAt          DateTime @default(now())
  CreatedBy          Int?
  UpdatedAt          DateTime @updatedAt
  UpdatedBy          Int?

  @@index([ReceiptCode])
  @@index([CompanyId])
  
  CreatedByUser      User? @relation("ReceiptCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser      User? @relation("ReceiptUpdatedBy", fields: [UpdatedBy], references: [UserId])

  PurchaseOrder      PurchaseOrder @relation(fields: [PurchaseOrderId], references: [PurchaseOrderId])
  Company            Company @relation(fields: [CompanyId], references: [CompanyId])
  ReceiptDetails     ReceiptDetail[]
  Stocks             Stock[]
}

model WithdrawnRequest {
  RequestId                 Int     @id @default(autoincrement())
  RequestDate               DateTime
  WithdrawnRequestStatus    String
  BranchId                  Int
  CompanyId                 Int
  WithdrawnRequestCode      String  @unique
  CreatedAt                 DateTime @default(now())
  CreatedBy                 Int?
  UpdatedAt                 DateTime @updatedAt
  UpdatedBy                 Int?

  @@index([WithdrawnRequestCode])
  @@index([CompanyId])

  CreatedByUser             User? @relation("WithdrawnRequestCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser             User? @relation("WithdrawnRequestUpdatedBy", fields: [UpdatedBy], references: [UserId])

  Branch                    Branch   @relation(fields: [BranchId], references: [BranchId])
  Company                   Company  @relation(fields: [CompanyId], references: [CompanyId])
  WithdrawnRequestDetails   WithdrawnRequestDetail[]
  Issues                    Issue[]
}

model ReceiptDetail {
  ReceiptDetailId        Int     @id @default(autoincrement())
  ReceiptId              Int
  PurchaseOrderDetailId  Int
  MaterialId             Int
  CompanyId              Int
  WarehouseId            Int
  MaterialQuantity       Int
  CreatedAt              DateTime @default(now())
  CreatedBy              Int?
  UpdatedAt              DateTime @updatedAt
  UpdatedBy              Int?

  @@index([ReceiptId])
  @@index([MaterialId])
  @@index([CompanyId])
  @@index([WarehouseId])

  CreatedByUser          User? @relation("ReceiptDetailCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser          User? @relation("ReceiptDetailUpdatedBy", fields: [UpdatedBy], references: [UserId])

  Receipt                Receipt   @relation(fields: [ReceiptId], references: [ReceiptId])
  PurchaseOrderDetail    PurchaseOrderDetail @relation(fields: [PurchaseOrderDetailId], references: [PurchaseOrderDetailId])
  Material               Material  @relation(fields: [MaterialId], references: [MaterialId])
  Company                Company   @relation(fields: [CompanyId], references: [CompanyId])
  Warehouse              Warehouse @relation(fields: [WarehouseId], references: [WarehouseId])

  @@unique([ReceiptId, MaterialId])
}

model WithdrawnRequestDetail {
  WithdrawnRequestDetailId Int     @id @default(autoincrement())
  RequestId               Int
  MaterialId              Int
  CompanyId               Int
  WithdrawnQuantity       Int
  CreatedAt               DateTime @default(now())
  CreatedBy               Int?
  UpdatedAt               DateTime @updatedAt
  UpdatedBy               Int?

  @@index([RequestId])
  @@index([MaterialId])
  @@index([CompanyId])

  CreatedByUser           User? @relation("WithdrawnRequestDetailCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser           User? @relation("WithdrawnRequestDetailUpdatedBy", fields: [UpdatedBy], references: [UserId])

  WithdrawnRequest        WithdrawnRequest @relation(fields: [RequestId], references: [RequestId])
  Material                Material         @relation(fields: [MaterialId], references: [MaterialId])
  Company                 Company          @relation(fields: [CompanyId], references: [CompanyId])

  @@unique([RequestId, MaterialId])
}

model Issue {
  IssueId      Int     @id @default(autoincrement())
  RequestId    Int    @unique
  BranchId     Int
  CompanyId    Int
  IssueStatus  String
  IssueDate    DateTime
  CreatedAt    DateTime @default(now())
  CreatedBy    Int?
  UpdatedAt    DateTime @updatedAt
  UpdatedBy    Int?

  @@index([RequestId])
  @@index([BranchId])
  @@index([CompanyId])

  CreatedByUser User? @relation("IssueCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser User? @relation("IssueUpdatedBy", fields: [UpdatedBy], references: [UserId])

  WithdrawnRequest WithdrawnRequest @relation(fields: [RequestId], references: [RequestId])
  Branch           Branch           @relation(fields: [BranchId], references: [BranchId])
  Company          Company          @relation(fields: [CompanyId], references: [CompanyId])
  IssueDetails     IssueDetail[]
}

model IssueDetail {
  IssueDetailId   Int      @id @default(autoincrement())
  RequestId       Int
  MaterialId      Int
  Barcode         String
  IssueQuantity   Int
  IssueId         Int
  CompanyId       Int
  CreatedAt       DateTime @default(now())
  CreatedBy       Int?
  UpdatedAt       DateTime @updatedAt
  UpdatedBy       Int?

  @@index([RequestId])
  @@index([MaterialId])
  @@index([CompanyId])

  CreatedByUser   User?    @relation("IssueDetailCreatedBy", fields: [CreatedBy], references: [UserId])
  UpdatedByUser   User?    @relation("IssueDetailUpdatedBy", fields: [UpdatedBy], references: [UserId])

  Issue           Issue    @relation(fields: [IssueId], references: [IssueId])
  Material        Material @relation(fields: [MaterialId], references: [MaterialId])
  Company         Company  @relation(fields: [CompanyId], references: [CompanyId])

  @@unique([IssueId, MaterialId, Barcode])
}